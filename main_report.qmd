---
title: "Group 3 Final Report"
authors: "Kamran Shirazi & Taylor Kirk"
date: "2025-11-14"
format:
  pdf:
    toc: true
---

```{r setup, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
library(fpp3)
library(tidyverse)
library(knitr)
library(gt)
library(urca)
```

# Introduction

Words words and more words

# Data Overview

```{r data-overview}
df <- read_csv("data/global_temp.csv")

dim(df)

str(df)

summary(df[3:12])
```

## Convert to Tsibble and Temperatures

Explain here about converting to temperatures and why

```{r convert-tsibble}

temp_data <- df |> mutate(
  Month = month.abb[Month],
  Date = yearmonth(paste(Month, Year)),
  Monthly_Anomaly = replace_na(Monthly_Anomaly, mean(Monthly_Anomaly, na.rm = T))) |>
  select(c(Date, Monthly_Anomaly)) |> 
  as_tsibble(index = Date)

baseline_vector <- c(
  '1' = 12.30, '2' = 12.50, '3' = 13.13, '4' = 14.06, 
  '5' = 15.00, '6' = 15.66, '7' = 15.90, '8' = 15.75, 
  '9' = 15.18, '10' = 14.27, '11' = 13.28, '12' = 12.57
)

converted_df <- temp_data |> 
  mutate(
    month_char = as.character(month(Date)),
    baseline_temp = baseline_vector[month_char],
    actual_temp = baseline_temp + Monthly_Anomaly
    ) |> 
  select(c(Date, actual_temp))
```

# Exploratory Data Analysis of Global Anomalies

```{r}
climate_raw <- readr::read_csv(
  "gistemp_monthly_anomalies.csv",
  skip = 1  # skip "Land-Ocean Temperature Index (C)"
)
```

```{r}
glimpse(climate_raw)
names(climate_raw)

```

With annual anomaly data dating back to 1880, the raw series shows substantial year-to-year fluctuations, while the LOWESS-smoothed line clarifies the unmistakable upward trend in global temperatures.

```{r}
climate_clean <- climate_raw |>
  janitor::clean_names() |>
  rename(
    year        = year,
    no_smoothing = no_smoothing,
    lowess_5    = lowess_5
  )
```

```{r}
glimpse(climate_clean)
names(climate_clean)
```

```{r}
climate_ts <- climate_clean |>
  as_tsibble(index = year)

climate_ts
```

The 1880s exhibit consistently negative temperature anomalies, with both raw and smoothed values showing a clear cool period centered around 1885–1887.

```{r}
climate_ts |>
  autoplot(no_smoothing) +
  labs(
    title = "Annual Global Temperature Anomalies (No Smoothing)",
    x = "Year",
    y = "Temperature Anomaly (°C, relative to 1951–1980)"
  ) +
  theme_minimal()

```

Temperatures fluctuate annually but show a clear upward trend, with modern anomalies far exceeding those of the early record.

```{r}
climate_stl <- climate_ts |>
  model(
    STL(no_smoothing ~ trend(window = 15))
  ) |>
  components()
```

```{r}
autoplot(climate_stl) +
  labs(
    title = "STL Decomposition of Annual Temperature Anomalies",
    x = "Year"
  ) +
  theme_minimal()
```

The STL results highlight how the underlying warming signal has grown stronger over time, while the remainder shows noisy but relatively modest deviations from the trend. This reinforces that annual variability exists but is dwarfed by the long-term increase in global temperatures.

```{r}
climate_ts |>
  gg_tsdisplay(no_smoothing, plot_type = "partial") +
  labs(
    title = "Annual Temperature Anomalies: Time Plot, ACF, and PACF"
  )

```

The climate series exhibits a persistent warming trend, and the ACF’s slow decay underscores how each year’s temperature is tightly linked to previous years. The PACF’s immediate drop-off reinforces that this warming signal creates strong year-to-year inertia in global temperatures.

```{r}
# KPSS
climate_ts |>
  features(no_smoothing, unitroot_kpss)
```

The KPSS test confirms what the plots already suggest: the anomaly series isn’t stationary, with the low p-value indicating that the warming trend dominates over random fluctuations.

```{r}
# Non-seasonal differencing needed?
climate_ts |>
  features(no_smoothing, unitroot_ndiffs)

climate_ts |>
  features(no_smoothing, guerrero)
```

λ ≈ 1.16 → little to no Box–Cox transformation needed; variance is already stable.

```{r eda-global-anomalies}
#| label: data-gistemp
#| echo: true
#| message: false
#| warning: false

temp_raw <- read_csv("global_tavg_monthly_cleaned_full.csv")

temp_ts <- temp_raw %>%
  mutate(
    Month = yearmonth(paste(Year, Month, sep = "-"))
  ) %>%
  # rename Monthly_Anomaly -> Anomaly so the rest of the code works
  rename(Anomaly = Monthly_Anomaly) %>%
  as_tsibble(index = Month) %>%
  arrange(Month)

train <- temp_ts %>% filter(Month < yearmonth("2020 Jan"))
test  <- temp_ts %>% filter(Month >= yearmonth("2020 Jan"))

autoplot(temp_ts, Anomaly) +
  labs(title = "Global Monthly Temperature Anomalies",
       x = "Year", y = "Temperature Anomaly (°C)")

```

The plot shows that what was once mostly cooler-than-average global temperatures has transitioned into a new normal of sustained warming, particularly over the last 40 years. The sharp upward trend in recent decades signals the accelerating pace of climate change.

```{r}
#| label: ets-model
#| echo: true
#| message: false
#| warning: false

# Fit ETS on the training data

fit_ets <- train %>%
model(ETS(Anomaly))

# Print model details

report(fit_ets)

```

```{r}
#| label: ets-forecast
#| echo: true
#| fig-cap: "Auto-ETS forecast vs actuals (full dataset)."

# Forecast same horizon as test (2020–2025)

fc_ets <- fit_ets %>%
forecast(h = nrow(test))

# Plot ETS forecast on the full timeline

autoplot(fc_ets, temp_ts) +
labs(
title = "Auto-ETS Forecast vs Actuals",
subtitle = "ETS model for monthly global temperature anomalies",
x = "Year",
y = "Temperature Anomaly (°C)"
)

```

The ETS(A,N,A) output highlights that although global temperatures fluctuate month to month, the underlying seasonal rhythm has stayed remarkably consistent across the historical record. The model assigns almost no seasonal updating (γ ≈ 0), indicating that warming is happening **in the level of the series rather than in the seasonal structure**.

```{r}
#| label: ets-forecast-zoom
#| echo: true
#| fig-cap: "Auto-ETS forecast vs actuals (2020–2025)."

fc_ets_zoom <- fc_ets %>%
filter_index("2020 Jan" ~ "2025 Dec")

autoplot(
fc_ets_zoom,
temp_ts %>% filter_index("2020 Jan" ~ "2025 Dec")
) +
labs(
title = "Auto-ETS Forecast vs Actuals (2020–2025)",
subtitle = "Automatically selected ETS model",
x = "Year",
y = "Temperature Anomaly (°C)"
)

```

The ETS model anticipates a fairly stable temperature anomaly level, yet the actual data reveal stronger warming spikes that repeatedly push toward the top of the prediction bands. This mismatch shows how rapidly recent warming is occurring relative to historical seasonal patterns captured by the model.

# Exploratory Data Analysis of Actual Global Temperatures

```{r eda-actual-temperatures}

summary(converted_df[2])

converted_df |> 
  model(STL(actual_temp)) |> 
  components() |> 
  autoplot() +
  labs(title = "STL Decomposition of Global Monthly Actual Temperatures") +
  theme_minimal()
```

Notes on what we see with the components. Constant seasonal, trend mainly flat until around 1980 then increasing, some remainder

```{r gg-season}

converted_df |> 
  ggtime::gg_season() + 
  theme_minimal()
```

Clearer picture at the increasing trend over time, occuring across all periods

```{r transformations}

features(converted_df, actual_temp, guerrero)
```

Lamdba estimation of 1.44, so a power transformation may be helpful

```{r acf-pacf}

gg_tsdisplay(converted_df, actual_temp, plot_type = 'partial')

features(converted_df, actual_temp, c(unitroot_kpss, unitroot_ndiffs, unitroot_nsdiffs))
```

much more clearly see the seasonal auto correlation now

need at least one difference and one seasonal difference

# Modeling / Forecasting

Using ETS, TSLM and ARIMA models on both anomalies and actual temperatures

## Anomaly Modeling

```{r anomaly-modeling}

```

## Actual Temperature Modeling

```{r training-split}
trn_data <- converted_df |>
  filter(year(Date) < 2020)

cv_trn <- trn_data |> 
  stretch_tsibble(.init = 960, .step = 60)
```

Modeling on all temp data prior to 2020, with cross validation sets created from the first 80 years of data (1850 - 1930) and rolling forward by 5 years (60 months). 1930 is when the temperature trend begins to increase more noticeably, so this will allow us to see how well the models can adapt to that change over time.

### ETS

```{r actual-temperature-ets}

ets_fit <- cv_trn |> 
  model(
    ets_auto = ETS(),
    additive = ETS(actual_temp ~ error("A") + trend("A") + season("A")),
    multiplicative = ETS(actual_temp ~ error("M") + trend("A") + season("M")),
    damped = ETS(actual_temp ~ error("A") + trend("Ad") + season("A")),
    log_auto = ETS(log(actual_temp)),
    box_cox_auto = ETS(box_cox(actual_temp, lambda = 1.5))
  )
```

```{r ets-training-metrics}

  ets_fit |> 
    accuracy() |> 
    group_by(.model) |> 
    summarise(across(.cols = c(RMSE, MAE, MAPE), .fns = mean)) |> 
    arrange(RMSE) |> 
    kable(digits = 2)

  ets_fit |> 
  tidy() |> 
  group_by(.model, term) |> 
  summarise(across(.cols = estimate, .fns = mean)) |> 
  pivot_wider(names_from = term, values_from = estimate) |> 
  kable(digits = 2)
```

```{r ets-forecasts}

forecast_horizon <- max(yearmonth(converted_df$Date)) - max(yearmonth(trn_data$Date))

ets_fc <- ets_fit |> 
  forecast(h = forecast_horizon)

ets_fc |> 
  accuracy(converted_df) |>
  arrange(RMSE) |> 
  kable(digets = 2)
```

```{r ets-diagnostics}

ets_fc |>
  filter(.id %in% c(18, 19)) |>
  autoplot() +
  autolayer(converted_df |> filter(year(Date) > 2005), actual_temp) +
  facet_grid(.model ~ .id) +
  theme_minimal()
```

ETS models have a hard time capturing the seasonal peaks, much more variation around then

```{r ets-residuals}

ets_fit |> 
  select(box_cox_auto) |>
  tail(n = 1) |> 
  gg_tsresiduals()
```

Checking just last model (trained on most data)

### TSLM

```{r actual-temperature-tslm}

tslm_fit <- cv_trn |> 
  model(
    tslm_auto = TSLM(actual_temp),
    tslm_trend = TSLM(actual_temp ~ trend()),
    tslm_trend_season = TSLM(actual_temp ~ trend() + season()),
    tslm_fourier = TSLM(actual_temp ~ trend() + fourier(K = 2)),
    tslm_log = TSLM(log(actual_temp) ~ trend() + season()),
    tslm_box_cox = TSLM(box_cox(actual_temp, lambda = 1.5) ~ trend() + season()),
    tslm_piecewise = TSLM(actual_temp ~ trend(knots = c(1920, 1975)) + season())
  )
```

Fourier terms for a simpler model, piecewise to capture changes in trend at those points

```{r tslm-training-metrics}

tslm_fit |> 
  accuracy() |> 
  group_by(.model) |> 
  summarise(across(.cols = c(RMSE, MAE, MAPE), .fns = mean)) |> 
  arrange(RMSE) |> 
  kable(digits = 2)

tslm_fit |> 
  select(tslm_fourier) |>
  tail(1) |>
  report()

## Full parameter table output
# tslm_fit |> 
#   tidy() |> 
#   group_by(.model, term) |> 
#   summarise(across(
#       .cols = c(estimate, std.error, statistic, p.value),
#       .fns = mean)
#   ) |> 
#   pivot_wider(
#     names_from = term, 
#     values_from = c(estimate, std.error, statistic, p.value)
#   ) |> 
#     kable(digits = 2)
```

```{r regressor-data}

el_nino <- read.csv("data/el_nino_events.csv")

full_temp_nino <- converted_df |> 
  mutate(join_year = year(Date)) |> 
  left_join(el_nino, by = c("join_year" = "Year")) |> 
  mutate(
    el_nino       = if_else(Phase == "El Niño", 1, 0, missing = 0),
    la_nina       = if_else(Phase == "La Niña", 1, 0, missing = 0)
  ) |> 
  select(-join_year, -Phase, -Strength) |> 
  filter(year(Date) > 1895) # this is the first year in the el nino data

tslm_model <- read_rds("data/tslm_regressor_ts.rds")
tslm_model <- tslm_model |> as_tsibble()
```

"How in depth do we need to go on the regressor data?"

```{r modeling-with-el_nino}

cv_nino_data <- tslm_model |> 
  stretch_tsibble(.init = 397, .step = 58)

cv_trn_nino <- cv_nino_data |> 
  group_by(.id) |> 
  slice(1:(n() - 60)) |> 
  ungroup()

cv_valid <- cv_nino_data |> 
  group_by(.id) |> 
  slice_tail(n = 60) |> 
  ungroup()


nino_fit <- cv_trn_nino |> 
  model(
    tslm_nino = TSLM(actual_temp ~ trend() + season() + el_nino + la_nina),
    tslm_co2 = TSLM(actual_temp ~ trend() + season() + el_nino + la_nina + co2),
    tslm_ch4 = TSLM(actual_temp ~ trend() + season() + el_nino + la_nina + co2 + ch4),
    tslm_tsi = TSLM(actual_temp ~ trend() + season() + el_nino + la_nina + co2 + ch4 + TSI)
  )

nino_fit |> 
  accuracy() |> 
  group_by(.model) |>
  summarise(across(.cols = c(RMSE, MAE, MAPE), .fns = mean)) |> 
  arrange(RMSE) |> 
  kable(digits = 2)

nino_fit |> 
  select(tslm_nino) |>
  tail(n = 1) |> 
  report()
```

```{r even-comparisons}

even_fit <- cv_trn_nino |> 
  model(
    tslm_nino = TSLM(actual_temp ~ trend() + season() + el_nino + la_nina),
    tslm_trend_season = TSLM(actual_temp ~ trend() + season()),
    tslm_box_cox = TSLM(box_cox(actual_temp, lambda = 1.5) ~ trend() + season()),
    tslm_piecewise = TSLM(actual_temp ~ trend(knots = c(1920, 1975)) + season())
  )

even_fit |> 
  accuracy() |> 
  group_by(.model) |>
  summarise(across(.cols = c(RMSE, MAE, MAPE), .fns = mean)) |> 
  arrange(RMSE) |> 
  kable(digits = 2)
```

```{r nino-forecasts}

tslm_nino_fc <- even_fit |> 
  forecast(new_data = cv_valid)

tslm_nino_fc |> 
  accuracy(cv_valid) |> 
  group_by(.model) |>
  summarise(across(.cols = c(RMSE, MAE, MAPE), .fns = mean)) |> 
  arrange(RMSE)

tslm_nino_fc |>
  filter(.id %in% c(20, 21)) |>
  autoplot() +
  autolayer(converted_df |> filter(year(Date) >= 2000), actual_temp) +
  facet_grid(.model ~ .id) +
  theme_minimal()
```
